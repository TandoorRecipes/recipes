{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans 'URL Import' %}{% endblock %}

{% block extra_head %}

    {% include 'include/vue_base.html' %}


    <script src="https://unpkg.com/vue-multiselect@2.1.0"></script>
    <link rel="stylesheet" href="https://unpkg.com/vue-multiselect@2.1.0/dist/vue-multiselect.min.css">
{% endblock %}

{% block content %}

    <div id="app">

        <div class="row">
            <div class="col-md-12">
                <div class="input-group mb-3">
                    <input class="form-control" v-model="remote_url">
                    <div class="input-group-append">
                        <button @click="loadRecipe()" class="btn btn-primary shadow-none" type="button"
                                id="id_btn_search"><i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <br/>

        <div v-if="loading" class="text-center">
            <br/>
            <i class="fas fa-spinner fa-spin fa-8x"></i>
        </div>

        <template v-if="recipe_data !== undefined">

            <form>
                <div class="form-group">
                    <label for="id_name">{% trans 'Recipe Name' %}</label>
                    <input id="id_name" class="form-control" v-model="recipe_data.name">
                </div>

                <div class="row">
                    <div class="col col-md-6" v-if="recipe_data.image !== ''">
                        <img v-bind:src="recipe_data.image" alt="{% trans 'Recipe Image' %}"
                             class="img-fluid img-responsive img-rounded">
                    </div>
                    <div class="col col-md-6">
                        <div class="form-group">
                            <label for="id_prep_time">{% trans 'Preparation time ca.' %}</label>
                            <input id="id_prep_time" class="form-control" v-model="recipe_data.prepTime">
                        </div>

                        <div class="form-group">
                            <label for="id_waiting_time">{% trans 'Waiting time ca.' %}</label>
                            <input id="id_waiting_time" class="form-control" v-model="recipe_data.cookTime">
                        </div>
                    </div>

                </div>
                <br/>

                <div class="row">
                    <div class="col-md-12">
                        <table class="table table-responsive-sm table-sm">
                            <thead>
                            <tr>
                                <th>{% trans 'Amount' %}</th>
                                <th>{% trans 'Unit' %}</th>
                                <th>{% trans 'Ingredient' %}</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>

                            <tr v-for="i in recipe_data.recipeIngredient">
                                <td><input class="form-control" v-model="i.amount"></td>
                                <td><input class="form-control" v-model="i.unit"></td>
                                <td><input class="form-control" v-model="i.ingredient"></td>
                                <td style="vertical-align: middle;text-align: center">
                                    <button class="btn btn-outline-danger" type="button" @click="deleteIngredient(i)"><i
                                            class="fas fa-trash-alt"></i></button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                        <div style="text-align: center">
                           <button class="btn btn-success" type="button" @click="addIngredient()"><i class="fas fa-plus"></i></button>
                        <br/><br/>
                        </div>

                    </div>
                </div>

                <div class="form-group">
                    <label for="id_instructions">{% trans 'Instructions' %}</label>
                    <textarea id="id_instructions" class="form-control" v-model="recipe_data.recipeInstructions"
                              rows="8"></textarea>
                </div>

                <div class="form-group">
                    <label for="id_keywords">{% trans 'Keywords' %}</label>

                    <multiselect
                            v-model="recipe_data.keywords"
                            :options="keywords"
                            :close-on-select="false"
                            :clear-on-select="true"
                            :hide-selected="true"
                            :preserve-search="true"
                            placeholder="Pick some"
                            label="text"
                            track-by="id"
                            id="id_keywords"
                            :multiple="true">
                    </multiselect>
                </div>

                <div class="form-group">
                    <label for="id_all_keywords">{% trans 'All Keywords' %}</label><br/>
                    <input id="id_all_keywords" type="checkbox"
                           v-model="all_keywords"> {% trans 'Import all Keywords not only the ones already existing.' %}
                </div>

                <div class="form-group">
                    <button type="button" @click="importRecipe()">{% trans 'Import' %}</button>
                </div>

                <br/>
                <br/>
                <br/>
            </form>
        </template>

        <template v-if="error !== undefined">
            <div>

                <div style="text-align: center">
                    <i class="fas fa-robot fa-8x"></i><br/><br/>
                    [[error.msg]]
                </div>
            </div>
            <br/>
            <div class="row">
                <div class="col-md-8 offset-md-2">
                    <div class="card border-info mb-6">
                        <div class="card-body text-info">
                            <h5 class="card-title">{% trans 'Information' %}</h5>
                            <p class="card-text">
                                {% blocktrans %} Only websites containing ld+json or microdata information can currently
                                    be imported. Most big recipe pages support this. If you site cannot be imported but
                                    you think
                                    it probably has some kind of structured data feel free to post an example in the
                                    github issues.{% endblocktrans %}
                            </p>
                            <a href="https://developers.google.com/search/docs/data-types/recipe" target="_blank"
                               rel="noreferrer nofollow"
                               class="card-link">{% trans 'Google ld+json Info' %}</a>
                            <a href="https://github.com/vabene1111/recipes/issues" target="_blank"
                               rel="noreferrer nofollow"
                               class="card-link">{% trans 'GitHub Issues' %}</a>
                            <a href="https://schema.org/Recipe" target="_blank" rel="noreferrer nofollow"
                               class="card-link">{% trans 'Recipe Markup Specification' %}</a>


                        </div>
                    </div>
                </div>
            </div>
        </template>

    </div>

    <script type="application/javascript">
        let csrftoken = Cookies.get('csrftoken');
        Vue.http.headers.common['X-CSRFToken'] = csrftoken;

        Vue.component('vue-multiselect', window.VueMultiselect.default)

        let app = new Vue({
            components: {
                Multiselect: window.VueMultiselect.default
            },
            delimiters: ['[[', ']]'],
            el: '#app',
            data: {
                remote_url: '',
                keywords: [],
                recipe_data: undefined,
                error: undefined,
                loading: false,
                all_keywords: false,
            },
            mounted: function () {
                this.getKeywords();
            },
            methods: {
                loadRecipe: function () {
                    this.recipe_data = undefined
                    this.error = undefined
                    this.loading = true
                    this.$http.get("{% url 'api_recipe_from_url' 12345 %}".replace(/12345/, this.remote_url)).then((response) => {
                        this.recipe_data = response.data;
                        this.loading = false
                    }).catch((err) => {
                        this.error = err.data
                        this.loading = false
                        console.log(err)
                    })
                },
                importRecipe: function () {
                    this.$set(this.recipe_data, 'all_keywords', this.all_keywords)
                    this.$http.post(`{% url 'data_import_url' %}`, this.recipe_data).then((response) => {
                        location.href = response.data
                    }).catch((err) => {
                        console.log("dragChanged create error", err);
                    })
                },
                deleteIngredient: function (i) {
                    this.recipe_data.recipeIngredient = this.recipe_data.recipeIngredient.filter(item => item !== i)
                },
                addIngredient: function (i) {
                    this.recipe_data.recipeIngredient.push({
                        unit: '{{ request.user.userpreference.default_unit }}',
                        amount: 0,
                        ingredient: ''
                    })
                },
                getKeywords: function () {
                    this.$http.get("{% url 'dal_keyword' %}").then((response) => {
                        this.keywords = response.data.results;
                    }).catch((err) => {
                        console.log(err)
                    })
                },
            }
        });
    </script>

{% endblock %}