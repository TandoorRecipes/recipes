{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans 'Meal-Plan' %}{% endblock %}

{% block extra_head %}
    {{ form.media }}
    <script src="{% static 'js/vue.min.js' %}"></script>
    <script src="{% static 'js/vue-resource.js' %}"></script>
    <script src="{% static 'js/moment-with-locales.min.js' %}"></script>

    <!-- CDNJS :: Sortable (https://cdnjs.com/) -->
    <script src="//cdn.jsdelivr.net/npm/sortablejs@1.8.4/Sortable.min.js"></script>
    <!-- CDNJS :: Vue.Draggable (https://cdnjs.com/) -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/Vue.Draggable/2.20.0/vuedraggable.umd.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.1/js.cookie.js"
            integrity="sha256-P8jY+MCe6X2cjNSmF4rQvZIanL5VwUUT4MBnOMncjRU=" crossorigin="anonymous"></script>

{% endblock %}

{% block content %}
    <style>
        .mealplan-cell .mealplan-add-button {
            text-align: center;
            display: block;
        }

        @media (hover: hover) {
            .mealplan-cell .mealplan-add-button {
                visibility: hidden;
                float: right;
                display: inline;
            }

            .mealplan-cell:hover .mealplan-add-button {
                visibility: initial;
            }
        }

    </style>

    <h3>
        {% trans 'Meal-Plan' %} <a href="{% url 'new_meal_plan' %}"><i class="fas fa-plus-circle"></i></a>
    </h3>

    <div id="app">
        <table class="table table-sm table-striped table-responsive">
            <thead class="thead-dark">
            <tr>
                <th v-for="d in days" style="width: 14.2%; text-align: center">[[d]]</th>
            </tr>
            </thead>
            <tbody v-for="mp in meal_plan">
            <tr>
                <td colspan="7" style="text-align: center">
                    [[mp.name]]
                </td>
            </tr>
            <tr>
                <td v-for="d in mp.days">
                    <draggable class="list-group" :list="d.items" group="plan" style="min-height: 40px"
                               @change="dragChanged(d.date, mp.meal_type, $event)"
                               :empty-insert-threshold="10">
                        <div class="list-group-item" v-for="(element, index) in d.items" :key="element.id">
                            <div class="row">
                                <div class="col-md-12">
                                    <a href="#" v-if="element.title !== ''"
                                       @click="plan_detail = element" data-toggle="modal" data-target="#exampleModal">[[element.title]]</a>
                                    <a href="#" v-if="element.recipe_name !== ''" @click="plan_detail = element"
                                       data-toggle="modal" data-target="#exampleModal">[[element.recipe_name]]</a>
                                    <a href="#" v-if="element.name !== ''"
                                       @click="plan_detail = element" data-toggle="modal" data-target="#exampleModal">[[element.name]]</a>
                                </div>
                            </div>
                        </div>
                    </draggable>
                </td>
            </tr>
            </tbody>
        </table>
        <hr/>
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        {% trans 'Recipes' %}
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <input type="text" class="form-control" v-model="recipe_query" @keyup="getRecipes"
                                       placeholder="{% trans 'Search Recipe' %}">
                                <!-- TODO remove recipes by backdropping them -->
                            </div>
                        </div>

                        <draggable class="list-group" :list="recipes"
                                   :group="{ name: 'plan', pull: 'clone', put: false }" :clone="cloneRecipe">
                            <div class="list-group-item" v-for="(element, index) in recipes" :key="element.id">
                                <a href="#">[[element.name]]</a>
                            </div>
                        </draggable>
                    </div>
                </div>

            </div>
            <div class="col-md-6">
                <div :key="-1">
                    <div class="card">
                        <div class="card-header">
                            {% trans 'New Note' %}
                        </div>
                        <div class="card-body">
                            <input type="text" class="form-control" v-model="new_note_title"
                                   placeholder="{% trans 'Title' %}">
                            <textarea class="form-control" v-model="new_note_text"
                                      placeholder="{% trans 'Note (optional)' %}"></textarea>

                            <draggable :list="pseudo_note_list"
                                       :group="{ name: 'plan', pull: 'clone', put: false }" :clone="cloneNote">
                                <div class="list-group-item" v-for="(element, index) in pseudo_note_list"
                                     :key="element.id">
                                    <button class="btn">{% trans 'Drag me' %}</button>
                                </div>
                            </draggable>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <br/>
        <hr/>
        <br/>
        [[meal_plan]]

        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" >[[ plan_detail.title ]] [[ plan_detail.recipe_name ]]</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                       [[ plan_detail.note ]]
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-danger" @click="deleteEntry(plan_detail)">{% trans 'Delete' %}</button>
                    </div>
                </div>
            </div>
        </div>

    </div>


    <script type="application/javascript">
        var week = moment().format('W')
        moment.locale('{{request.LANGUAGE_CODE}}');

        var csrftoken = Cookies.get('csrftoken');
        Vue.http.headers.common['X-CSRFToken'] = csrftoken;

        var app = new Vue({
            delimiters: ['[[', ']]'],
            el: '#app',
            data: {
                days: moment.weekdays(),
                plan_entries: [],
                meal_types: [],
                meal_plan: {},
                plan_detail: {},
                recipes: [],
                recipe_query: '',
                pseudo_note_list: [
                    {id: 0, title: '', text: ''}
                ],
                new_note_title: '',
                new_note_text: '',
            },
            mounted: function () {
                console.log("MOUNTED")
                this.getPlanEntries();
            },
            methods: { // TODO stop chain loading and do async
                getPlanEntries: function () {
                    this.$http.get("{% url 'api:mealplan-list' %}?week=" + week).then((response) => {
                        this.plan_entries = response.data;
                        this.getPlanTypes();
                    }).catch((err) => {
                        this.loading = false;
                        console.log(err);
                    })
                },
                getPlanTypes: function () {
                    this.$http.get("{% url 'api:mealtype-list' %}").then((response) => {
                        this.meal_types = response.data;
                        this.buildGrid();
                    }).catch((err) => {
                        console.log(err);
                    })
                },
                buildGrid: function () {
                    console.log("BUILD GRID EXECUTED")
                    for (t of this.meal_types) {
                        this.$set(this.meal_plan, t.id, {
                            name: t.name,
                            meal_type: t.id,
                            days: {}
                        })
                        for (d of this.days) {
                            date = moment().day(d).week(week).format('YYYY-MM-DD')
                            this.$set(this.meal_plan[t.id].days, date, {
                                name: d,
                                date: date,
                                items: []
                            })
                        }
                    }
                    for (e of this.plan_entries) {
                        this.meal_plan[e.meal_type].days[e.date].items.push(e)
                    }
                    this.getRecipes();
                },
                getRecipes: function () {
                    let url = "{% url 'api:recipe-list' %}?limit=5"
                    if (this.recipe_query !== '') {
                        url += '&query=' + this.recipe_query;
                    }

                    this.$http.get(url).then((response) => {
                        this.recipes = response.data;
                    }).catch((err) => {
                        console.log(err);
                    })
                },
                dragChanged: function (date, meal_type, evt) {
                    console.log("log")
                    if (evt.added !== undefined) {
                        console.log("added")

                        let plan_entry = evt.added.element

                        plan_entry.date = date
                        plan_entry.meal_type = meal_type

                        if (plan_entry.is_recipe || plan_entry.is_note) { // its not a meal plan object
                            console.log("undef")
                            plan_entry.created_by = {{ request.user.id }};

                            this.$http.post(`{% url 'api:mealplan-list' %}`, plan_entry).then((response) => {
                                console.log("create success", response)
                                let entry = response.data
                                this.meal_plan[entry.meal_type].days[entry.date].items = this.meal_plan[entry.meal_type].days[entry.date].items.filter(item => item.id === undefined)
                                this.meal_plan[entry.meal_type].days[entry.date].items.push(entry)
                            }).catch((err) => {
                                console.log("create error", err);
                            })
                        } else {
                            this.$http.put(`{% url 'api:mealplan-list' %}${plan_entry.id}/`, plan_entry).then((response) => {
                                console.log("Update success", response)
                            }).catch((err) => {
                                console.log("update error", err);
                            })
                        }
                    }
                },
                deleteEntry: function (entry) {
                    console.log("delete click")
                    $('#exampleModal').modal('hide')
                    this.plan_detail = {}
                    this.$http.delete(`{% url 'api:mealplan-list' %}${entry.id}/`, entry).then((response) => {
                        console.log("delete success", response)
                        this.meal_plan[entry.meal_type].days[entry.date].items = this.meal_plan[entry.meal_type].days[entry.date].items.filter(item => item !== entry)
                    }).catch((err) => {
                        console.log("delete error", err);
                    })
                },
                cloneRecipe: function (recipe) {
                    console.log("clone recipe")
                    return {
                        id: Math.round(Math.random() * 1000) + 10000,
                        recipe: recipe.id,
                        recipe_name: recipe.name,
                        is_recipe: true
                    }
                },
                cloneNote: function () {
                    console.log("clone note")
                    let new_entry = {
                        id: Math.round(Math.random() * 1000) + 10000,
                        title: this.new_note_title,
                        text: this.new_note_text,
                        is_note: true,
                    }

                    if (new_entry.title === '') {
                        new_entry.title = '{% trans 'Title' %}'
                    }

                    this.new_note_title = ''
                    this.new_note_text = ''
                    return new_entry
                }
            }
        });
    </script>
{% endblock %}