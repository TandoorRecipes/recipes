name: Dependabot Auto-merge

on:
  pull_request_target:
    types: [opened,  synchronize, reopened, ready_for_review]

permissions:
  contents: read

jobs:
  validate:
    if: contains(github.event.pull_request.labels.*.name, 'automerge') && github.event.pull_request.user.login != 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Remove automerge label
        uses: actions-ecosystem/action-remove-labels@d05162525702062b6bdef750ed8594fc024b3ed7  # v1.3.0
        with:
          labels: automerge

      - name: Add invalid label
        uses: actions-ecosystem/action-add-labels@1a9c3715c0037e96b97bb38cb4c4b56a1f1d4871  # v1.1.0
        with:
          labels: invalid
          
      - name: Comment restriction
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043  # v4.0.0
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ‚ö†Ô∏è **Automerge Restriction Notice**
            
            The `automerge` label has been removed from this PR because it has restricted use. Only PRs created by `dependabot[bot]` are allowed to use the automerge functionality.
            
            If you believe this is an error, please contact a repository maintainer.
  
  auto-merge:
    if: github.actor == 'dependabot[bot]' && contains(github.event.pull_request.labels.*.name, 'automerge')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_PRIVATE_KEY }}

      - name: Auto-approve PR
        uses: hmarr/auto-approve-action@b40d6c9ed2fa10c9a2749eca7eb004418a705501  # v4.0.0
        with:
          github-token: ${{ steps.generate_token.outputs.token }}
          review-message: |
            ü§ñ **Dependabot Auto-merge**
            
            This PR has been automatically approved and enabled for auto-merge. It will be merged automatically once all required checks pass.
          
      - name: Enable auto-merge
        uses: daneden/enable-automerge-action@f8558b65c5b8d8bfb592c4e74e3d491624a38fbd  # v1.0.0
        with:
          github-token: ${{ steps.generate_token.outputs.token }}
          allowed-author: "dependabot[bot]"
          merge-method: REBASE # Allowed values: MERGE | SQUASH | REBASE