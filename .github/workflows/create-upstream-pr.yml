name: Create Upstream PR

on:
  workflow_run:
    workflows: ["Push Workflow"]
    types:
      - completed
    branches: [working]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  create-upstream-pr:
    runs-on: ubuntu-latest
    concurrency:
      group: upstream-pr
      cancel-in-progress: true
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup git user
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"

      - name: Add upstream remote
        run: |
          git remote get-url upstream || git remote add upstream https://github.com/TandoorRecipes/recipes.git
          git fetch upstream

      - name: Ensure jq is available
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

      - name: Create upstream PR branch
        id: create_branch
        run: |
          BRANCH_NAME="upstream-pr-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME" || { echo "❌ Failed to create branch $BRANCH_NAME"; exit 1; }
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "✅ Created branch: $BRANCH_NAME"

      - name: Restore upstream infrastructure files
        id: restore_infra
        run: |
          BRANCH_NAME="${{ steps.create_branch.outputs.branch_name }}"
          git checkout "$BRANCH_NAME"
          git rm .gitattributes || echo "ℹ️ .gitattributes not present, skipping removal."
          git checkout upstream/tandoor-1 -- .github/workflows/ || echo "ℹ️ No workflows to restore."
          git checkout upstream/tandoor-1 -- cookbook/version_info.py || echo "ℹ️ No version_info.py to restore."
          git add .
          if ! git diff --cached --quiet; then
            git commit -m $'Restore upstream infrastructure files for PR\n\n- Removed fork-specific .gitattributes\n- Restored upstream .github/workflows/\n- Restored upstream cookbook/version_info.py'
            echo "✅ Infrastructure files restored and committed."
          else
            echo "ℹ️ No infrastructure changes to commit."
          fi

      - name: Merge upstream branch
        id: merge_upstream
        run: |
          BRANCH_NAME="${{ steps.create_branch.outputs.branch_name }}"
          git checkout "$BRANCH_NAME"
          if git merge --no-edit upstream/tandoor-1; then
            echo "✅ Merged upstream/tandoor-1 into $BRANCH_NAME"
          else
            echo "❌ Merge conflict detected during merge with upstream/tandoor-1. Please resolve conflicts manually." >&2
            exit 1
          fi

      - name: Get commit list
        id: get_commits
        run: |
          BRANCH_NAME="${{ steps.create_branch.outputs.branch_name }}"
          COMMITS_RAW=$(git log upstream/tandoor-1..$BRANCH_NAME --oneline)
          if [ -z "$COMMITS_RAW" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "✅ No commits to contribute - exiting gracefully"
            exit 0
          fi
          echo "commits_raw<<EOF" >> $GITHUB_OUTPUT
          printf "%s\n" "$COMMITS_RAW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Get changed files
        id: get_files
        run: |
          BRANCH_NAME="${{ steps.create_branch.outputs.branch_name }}"
          CHANGED_FILES=$(git diff upstream/tandoor-1..$BRANCH_NAME --name-only)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          printf "%s\n" "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Filter code and infrastructure files
        id: filter_files
        run: |
          is_infrastructure_file() {
            local file="$1"
            case "$file" in
              .github|.github/*|cookbook/version*.py|.gitattributes) return 0 ;;
              *) return 1 ;;
            esac
          }
          CODE_FILES=()
          INFRASTRUCTURE_FILES=()
          while IFS= read -r file; do
            if is_infrastructure_file "$file"; then
              INFRASTRUCTURE_FILES+=("$file")
            else
              CODE_FILES+=("$file")
            fi
          done <<< "${{ steps.get_files.outputs.changed_files }}"
          echo "code_files<<EOF" >> $GITHUB_OUTPUT
          printf "%s\n" "${CODE_FILES[@]}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "infra_files<<EOF" >> $GITHUB_OUTPUT
          printf "%s\n" "${INFRASTRUCTURE_FILES[@]}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "code_count=${#CODE_FILES[@]}" >> $GITHUB_OUTPUT
          echo "infra_count=${#INFRASTRUCTURE_FILES[@]}" >> $GITHUB_OUTPUT

      - name: Summarize changes
        id: summarize_changes
        run: |
          CODE_COUNT=${{ steps.filter_files.outputs.code_count }}
          INFRA_COUNT=${{ steps.filter_files.outputs.infra_count }}
          CHANGES_SUMMARY="Modified $CODE_COUNT code files"
          if [ "$INFRA_COUNT" -gt 0 ]; then
            CHANGES_SUMMARY="$CHANGES_SUMMARY and $INFRA_COUNT infrastructure files"
          fi
          echo "changes_summary=$CHANGES_SUMMARY" >> $GITHUB_OUTPUT

      - name: Prepare commit subjects and JSON
        id: prepare_commits
        run: |
          COMMITS_RAW="${{ steps.get_commits.outputs.commits_raw }}"
          CODE_FILES=( $(echo "${{ steps.filter_files.outputs.code_files }}") )
          FILTERED_COMMITS_JSON="[]"
          COMMIT_SUBJECTS_ARRAY=()
          is_infrastructure_file() {
            local file="$1"
            case "$file" in
              .github|.github/*|cookbook/version*.py|.gitattributes) return 0 ;;
              *) return 1 ;;
            esac
          }
          while IFS= read -r commit_line; do
            if [ -z "$commit_line" ]; then continue; fi
            COMMIT_SHA=$(echo "$commit_line" | cut -d' ' -f1)
            COMMIT_SUBJECT=$(echo "$commit_line" | cut -d' ' -f2-)
            COMMIT_SUBJECTS_ARRAY+=("- $COMMIT_SUBJECT")
            mapfile -t COMMIT_FILES < <(git diff-tree --no-commit-id --name-only -r "$COMMIT_SHA")
            HAS_CODE_CHANGES=false
            NON_INFRA_FILES=()
            for commit_file in "${COMMIT_FILES[@]}"; do
              if ! is_infrastructure_file "$commit_file"; then
                HAS_CODE_CHANGES=true
                NON_INFRA_FILES+=("$commit_file")
              fi
            done
            if [ "$HAS_CODE_CHANGES" = "true" ]; then
              FILES_JSON=$(printf '%s\n' "${NON_INFRA_FILES[@]}" | jq -R . | jq -s .)
              COMMIT_JSON=$(jq -n --arg sha "$COMMIT_SHA" --arg subject "$COMMIT_SUBJECT" --argjson files "$FILES_JSON" '{sha: $sha, subject: $subject, files: $files}')
              FILTERED_COMMITS_JSON=$(echo "$FILTERED_COMMITS_JSON" | jq --argjson item "$COMMIT_JSON" '. + [$item]')
            fi
          done <<< "$COMMITS_RAW"
          echo 'commits_json<<EOF' >> $GITHUB_OUTPUT
          printf "%s\n" "$FILTERED_COMMITS_JSON" >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT
          echo "commit_subjects<<EOF" >> $GITHUB_OUTPUT
          printf '%s\n' "${COMMIT_SUBJECTS_ARRAY[@]}" >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Push branch to fork
        if: steps.get_commits.outputs.has_changes == 'true'
        run: |
          BRANCH_NAME="${{ steps.create_branch.outputs.branch_name }}"
          git push --set-upstream origin "$BRANCH_NAME"
          echo "✅ Branch pushed: $BRANCH_NAME"

      - name: Get trigger PR info
        if: steps.get_commits.outputs.has_changes == 'true'
        id: get_trigger_pr
        uses: actions/github-script@v7
        env:
          EVENT_NAME: ${{ github.event_name }}
          WORKFLOW_RUN_HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            let triggerPRTitle = 'Sync changes from fork';
            let triggerPRUrl = '';
            // Get owner and repo from environment
            const [owner, repo] = (process.env.GITHUB_REPOSITORY || '').split('/');
            const eventName = process.env.EVENT_NAME;
            const workflowRunHeadSha = process.env.WORKFLOW_RUN_HEAD_SHA;
            if (eventName === 'workflow_run' && workflowRunHeadSha) {
              try {
                const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                  owner,
                  repo,
                  commit_sha: workflowRunHeadSha
                });
                const pr = prs.data.find(pr => pr.state === 'open' || pr.merged_at);
                if (pr) {
                  triggerPRTitle = pr.title;
                  triggerPRUrl = pr.html_url;
                } else {
                  const commit = await github.rest.repos.getCommit({
                    owner,
                    repo,
                    ref: workflowRunHeadSha
                  });
                  triggerPRTitle = commit.data.commit.message.split('\n')[0];
                }
              } catch (error) {
                if (error.status === 404) {
                  console.log(`Warning: Commit ${workflowRunHeadSha} not found`);
                } else if (error.status === 403) {
                  console.log(`Warning: Rate limited or permission denied: ${error.message}`);
                } else {
                  console.log(`Warning: Could not get trigger PR info: ${error.message}`);
                }
              }
            }
            return {
              triggerPRTitle: triggerPRTitle || '',
              triggerPRUrl: triggerPRUrl || ''
            };

      - name: Build PR content
        if: steps.get_commits.outputs.has_changes == 'true'
        id: build_pr_content
        uses: actions/github-script@v7
        env:
          COMMITS_JSON: ${{ steps.prepare_commits.outputs.commits_json }}
          COMMIT_SUBJECTS: ${{ steps.prepare_commits.outputs.commit_subjects }}
          INFRASTRUCTURE_FILES: ${{ steps.filter_files.outputs.infra_files }}
          CHANGES_SUMMARY: ${{ steps.summarize_changes.outputs.changes_summary }}
          TRIGGER_PR_TITLE: ${{ steps.get_trigger_pr.outputs.triggerPRTitle }}
          TRIGGER_PR_URL: ${{ steps.get_trigger_pr.outputs.triggerPRUrl }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commits = process.env.COMMITS_JSON || '[]';
            const commitSubjects = process.env.COMMIT_SUBJECTS || '';
            const infrastructureFiles = process.env.INFRASTRUCTURE_FILES || '[]';
            const changesSummary = process.env.CHANGES_SUMMARY || 'Changes from fork';
            const triggerPRTitle = process.env.TRIGGER_PR_TITLE || 'Sync changes from fork';
            const triggerPRUrl = process.env.TRIGGER_PR_URL || '';
            const commitsArray = JSON.parse(commits);
            const infrastructureArray = JSON.parse(infrastructureFiles);
            const prTitle = triggerPRTitle ||
              `Upstream PR: ${commitsArray.length} commit${commitsArray.length !== 1 ? 's' : ''} from fork`;
            let prBody = `## 🔄 Automated Fork → Upstream PR\n\nThis PR contains changes from the fork that are ready for upstream inclusion.\n\n`;
            if (triggerPRUrl) {
              prBody += `**Source PR:** ${triggerPRUrl}\n\n`;
            }
            prBody += `**Changes Summary:**\n${changesSummary}\n\n**Commits Included:** ${commitsArray.length}\n${commitSubjects}\n\n`;
            if (infrastructureArray.length > 0) {
              prBody += `**⚠️ Infrastructure Files Modified:**\n${infrastructureArray.map(file => `- ${file}`).join('\n')}\n\nThese changes have been reviewed and are safe for upstream inclusion.\n\n`;
            }
            prBody += `\n---\n*This PR was automatically created from the fork after successful CI validation.*\n`;
            return {
              prTitle: prTitle || '',
              prBody: prBody || '',
              triggerPRUrl: triggerPRUrl || ''
            };

      - name: Create upstream PR
        if: steps.get_commits.outputs.has_changes == 'true'
        id: create_pr
        uses: actions/github-script@v7
        env:
          PR_TITLE: ${{ steps.build_pr_content.outputs.prTitle }}
          PR_BODY: ${{ steps.build_pr_content.outputs.prBody }}
          BRANCH_NAME: ${{ steps.create_branch.outputs.branch_name }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prTitle = process.env.PR_TITLE || '';
            const prBody = process.env.PR_BODY || '';
            const branchName = process.env.BRANCH_NAME || '';
            let pr;
            try {
            // Get owner and repo from environment
            const [owner, repo] = (process.env.GITHUB_REPOSITORY || '').split('/');
            const { data: prData } = await github.rest.pulls.create({
                owner: 'TandoorRecipes',
                repo: 'recipes',
                title: prTitle,
                body: prBody,
                head: `${owner}:${branchName}`,
                base: 'tandoor-1'
              });
              pr = prData;
            } catch (error) {
              if (error.status === 422) {
                console.log('⚠️ PR already exists for this branch - skipping creation');
                return { pr_number: '', pr_url: '' };
              }
              throw error;
            }
            console.log(`✅ Created upstream PR #${pr.number}: ${pr.html_url}`);
            return {
              pr_number: pr.number ? pr.number.toString() : '',
              pr_url: pr.html_url || ''
            };

      - name: Comment on original PR
        if: steps.get_commits.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        env:
          TRIGGER_PR_URL: ${{ steps.build_pr_content.outputs.triggerPRUrl }}
          UPSTREAM_PR_URL: ${{ steps.create_pr.outputs.pr_url }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const triggerPRUrl = process.env.TRIGGER_PR_URL;
            const upstreamPRUrl = process.env.UPSTREAM_PR_URL;
            // Only comment if both URLs are present
            if (triggerPRUrl && upstreamPRUrl) {
              const prMatch = triggerPRUrl.match(/\/pull\/(\d+)/);
              if (prMatch) {
                const triggerPRNumber = parseInt(prMatch[1]);
                // Get owner and repo from environment
                const [owner, repo] = (process.env.GITHUB_REPOSITORY || '').split('/');
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: triggerPRNumber,
                  body: `🚀 **Upstream PR Created**\n\nYour changes have been submitted to the upstream repository:\n\n**Upstream PR:** ${upstreamPRUrl}\n\nThe upstream maintainers will review and merge when ready.`
                });
              }
            }

      - name: Comment on success
        if: steps.get_commits.outputs.has_changes == 'true' && steps.create_pr.outcome == 'success'
        run: echo "✅ Successfully created upstream PR!"