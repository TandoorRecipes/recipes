name: Auto-update recipe-scrapers

on:
  schedule:
    - cron: '0 5 * * *'  # Daily at 5am UTC
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update recipe-scrapers to latest
        run: |
          # Install jq for JSON parsing
          sudo apt-get update && sudo apt-get install -y jq
          
          # Get latest version from PyPI
          LATEST=$(curl -s https://pypi.org/pypi/recipe-scrapers/json | jq -r .info.version)
          
          # Update requirements.txt
          sed -i "s/^recipe-scrapers==.*/recipe-scrapers==${LATEST}/" requirements.txt
          
          # Check if anything changed
          if git diff --quiet requirements.txt; then
            echo "No update needed - already at latest version"
            exit 0
          fi
          
          echo "Updated to version: $LATEST"

      - name: Create PR and enable automerge
        uses: peter-evans/create-pull-request@v5
        id: create-pr
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update recipe-scrapers to latest version"
          title: "chore: update recipe-scrapers to latest version"
          body: |
            Automated update of recipe-scrapers to the latest version.
            
            This PR will be automatically merged if all checks pass.
          branch: update-recipe-scrapers
          delete-branch: true
          labels: |
            dependencies

      - name: Auto-approve and enable automerge
        if: steps.create-pr.outputs.pull-request-number
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.create-pr.outputs.pull-request-number }}

      - name: Enable auto-merge
        if: steps.create-pr.outputs.pull-request-number
        uses: alexwilson/enable-github-automerge-action@2.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          merge-method: "SQUASH"
